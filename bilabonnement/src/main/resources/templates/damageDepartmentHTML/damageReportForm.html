<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Skadesrapport</title>
    <!-- Ekstern styling for formularen -->
    <link rel="stylesheet" th:href="@{/css/forms/damageReportForm.css}">
</head>
<body>
<div class="page-wrapper">
    <!-- Top-overskrift for siden -->
    <div class="top-header">Skadesrapport</div>

    <!-- Formularen, der poster til /damageReportForm/save og binder til damageReport-objektet -->
    <form id="damageForm"
          th:action="@{/damageReportForm/save}"
          th:object="${damageReport}"
          method="post"
          class="damage-form">

        <!-- Skjult primærnøgle: nødvendig for at opdatere (merge) i stedet for at oprette nyt -->
        <input type="hidden" th:field="*{damageReportId}"/>

        <!-- Basisoplysninger (lease og relateret info) -->
        <div class="input-wrapper">
            <span>Lejekontrakt ID</span>
            <input type="number" th:field="*{leasingContractId}">
        </div>

        <div class="input-wrapper">
            <span>Vehicle ID</span>
            <!-- Læsefelt fra modelattributter (beregnet i controller) -->
            <input type="text" th:value="${vehicleId}" readonly>
        </div>

        <div class="input-wrapper">
            <span>Renter ID</span>
            <input type="text" th:value="${renterId}" readonly>
        </div>

        <div class="input-wrapper">
            <span>Dato for rapport</span>
            <!-- Binder til LocalDate i modellen -->
            <input type="date" th:field="*{reportDate}">
        </div>

        <!-- Kilometertal (valideres i controlleren; viser fejltekst under feltet) -->
        <div class="input-wrapper">
            <span>Kilometertal</span>
            <input type="number"
                   th:field="*{totalKm}"
                   min="0" max="999999" inputmode="numeric"
                   th:classappend="${kmError != null} ? ' is-invalid' : ''">
            <!-- Fejlbesked for km (vises kun hvis kmError er sat i model) -->
            <div class="error" th:if="${kmError != null}" th:text="${kmError}"></div>
        </div>

        <!-- Skadessektion (liste af skader, kan tilføjes/fjernes dynamisk) -->
        <div class="damage-section-box">
            <h3 class="damage-title">Skader</h3>

            <!-- Hver skaderække binder til damageItems[i] -->
            <div class="damage-list" th:each="item, iter : *{damageItems}">
                <div class="damage-row">

                    <!-- Visuelt løbenummer -->
                    <div class="damage-field id">
                        <label>Nr.</label>
                        <input type="text" th:value="${iter.index + 1}" readonly>
                    </div>

                    <!-- Skjult item-id (krævet for korrekt update/merge af eksisterende rækker) -->
                    <input type="hidden" th:field="*{damageItems[__${iter.index}__].damageItemId}"/>

                    <!-- Beskrivelse af skade -->
                    <div class="damage-field description">
                        <label>Beskrivelse</label>
                        <input type="text" th:field="*{damageItems[__${iter.index}__].description}">
                    </div>

                    <!-- Prisfelt (valideres i controlleren; samlet fejl vises nederst i boksen) -->
                    <div class="damage-field price">
                        <label>Pris</label>
                        <input type="number"
                               th:field="*{damageItems[__${iter.index}__].damageItemPrice}"
                               min="0" step="0.01" inputmode="decimal">
                    </div>

                    <!-- Fjern én skaderække (klient-side) -->
                    <button type="button"
                            class="remove-btn"
                            onclick="removeRow(this)"
                            aria-label="Fjern">−</button>
                </div>
            </div>

            <!-- Tilføj ny skaderække (klient-side) -->
            <button class="add-btn" type="button"
                    onclick="
                      const list = this.closest('.damage-section-box').querySelector('.damage-list');
                      const idx  = list.querySelectorAll('.damage-row').length;
                      const row  = document.createElement('div');
                      row.className='damage-row';
                      row.innerHTML =
                        `<div class='damage-field id'><label>Nr.</label><input type='text' value='${idx+1}' readonly></div>
                         <input type='hidden' name='damageItems[${idx}].damageItemId' value=''/>
                         <div class='damage-field description'><label>Beskrivelse</label>
                           <input name='damageItems[${idx}].description' type='text'></div>
                         <div class='damage-field price'><label>Pris</label>
                           <input name='damageItems[${idx}].damageItemPrice' type='number' min='0' step='0.01' inputmode='decimal'></div>
                         <button type='button' class='remove-btn' onclick='removeRow(this)' aria-label='Fjern'>−</button>`;
                      list.appendChild(row);
                      reindexRows();  /* Opdater navne-indekser så bindingen passer */
                    "
                    aria-label="Tilføj">+</button>

            <!-- Felt der viser samlet pris for skader (beregnes i service/recalc og bindes hertil) -->
            <div class="input-wrapper">
                <span>Pris i alt (skader)</span>
                <input type="number" th:field="*{totalDamagePrice}" readonly>
            </div>

            <!-- Samlet pris-fejl (vises kun hvis priceError er sat i model) -->
            <div class="error" th:if="${priceError != null}" th:text="${priceError}"></div>
        </div>

        <!-- Afledte felter (beregnet i controller/service) -->
        <div class="input-wrapper">
            <span>Kørte kilometer</span>
            <input type="number" th:value="${drivenKm}" readonly>
        </div>

        <div class="input-wrapper">
            <span>Pris for ekstra km</span>
            <input type="number" th:value="${extraKmPrice}" readonly>
        </div>

        <div class="input-wrapper">
            <span>Pris i alt</span>
            <input type="number" th:field="*{totalPrice}" readonly>
        </div>

        <!-- Betalt-status (binder til transient felt paidStatus, som spejler hasPayed) -->
        <div class="paid-section">
            <label>Betalt?</label>
            <label><input type="radio" th:field="*{paidStatus}" value="true"> Ja</label>
            <label><input type="radio" th:field="*{paidStatus}" value="false"> Nej</label>
        </div>
    </form>

    <!-- Handlingsknapper (tilbage, gem, opret ny) -->
    <div class="action-buttons">
        <!-- Tilbage: holder din styling (button) men navigerer til oversigten -->
        <button class="back" type="button"
                th:onclick="'window.location.href=\'' + @{/damageDepartment} + '\';'">
            Tilbage
        </button>

        <!-- Gem: poster formularen -->
        <button class="save" type="submit" form="damageForm">Gem</button>

        <!-- Opret ny / genindlæs tom formular (med leaseId hvis sat) -->
        <form th:action="@{/damageReportForm/new}" method="get" style="display:inline">
            <input type="hidden" name="leaseId" th:value="*{leasingContractId}" />
            <button class="delete" type="submit">Opret Ny</button>
        </form>
    </div>

</div>

<!-- === Server-renderet fejlboks (vises kun hvis kmError eller priceError er sat) === -->
<div th:if="${kmError != null or priceError != null}" class="modal">
    <div class="modal-content">
        <h3>Ugyldigt input</h3>
        <ul class="error-list">
            <li th:if="${kmError != null}" th:text="${kmError}"></li>
            <li th:if="${priceError != null}" th:text="${priceError}"></li>
        </ul>

        <!-- OK-knap: loader samme formular igen (bevarer leaseId så info kan vises) -->
        <form th:action="@{/damageReportForm/new}" method="get">
            <input type="hidden" name="leaseId" th:value="*{leasingContractId}"/>
            <button type="submit" class="save">OK</button>
        </form>
    </div>
</div>

<!-- === Reindex-logic (holder navne-indekser for items korrekte ved tilføj/slet) === -->
<script>
    function reindexRows() {
        const rows = document.querySelectorAll('.damage-section-box .damage-list .damage-row');
        rows.forEach((row, i) => {
            // skjult id
            const hid = row.querySelector("input[type='hidden'][name^='damageItems['][name$='.damageItemId']");
            if (hid) hid.name = `damageItems[${i}].damageItemId`;
            // beskrivelse
            const desc = row.querySelector("input[name^='damageItems['][name$='.description']");
            if (desc) desc.name = `damageItems[${i}].description`;
            // pris
            const price = row.querySelector("input[name^='damageItems['][name$='.damageItemPrice']");
            if (price) price.name = `damageItems[${i}].damageItemPrice`;
            // visuelt nr.
            const nr = row.querySelector(".damage-field.id input[readonly]");
            if (nr) nr.value = i + 1;
        });
    }

    function removeRow(btn) {
        const row = btn.closest('.damage-row');
        if (!row) return;
        row.remove();
        reindexRows(); // opdater indeks efter sletning
    }

    // Sørg for reindex lige inden submit (hvis der er 'huller' i index)
    document.getElementById('damageForm').addEventListener('submit', reindexRows);
</script>
</body>
</html>
